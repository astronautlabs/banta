rules_version = '2';
service cloud.firestore {
  function r() {
    return /databases/$(database)/documents;
  }
  
  function canAccessUser(userId) {
    return isUser(userId) || isAdmin();
  }
  
  function isUser(userId) {
    return request.auth != null && request.auth.uid == userId;
  }
  
  function isAdmin() {
    return get(/$(r())/staff/$(request.auth.uid)).data.admin == true;
  }
  
  function isLoggedIn() {
    return request.auth != null;
  }
    
  
  function isOwnerOf(res) {
    return request.auth != null 
      && res != null 
      && request.auth.uid == res.data.ownerId
    ;
  }
    
  match /databases/{database}/documents {
    match /bantaUsers/{userId} {
      allow read: if canAccessUser(userId);
    }
    
    match /bantaUsers/{userId}/notifications {
      allow read;
    }
    
    match /bantaUsers/{userId}/notifications/{notifId} {
      allow read: if canAccessUser(userId);
    }
    
    match /bantaTopics/{topicID}/messages/{messageID} {
      allow read;
    }    
    
    match /bantaTopics/{topicID}/counters/{counterID} {
      allow read;
    }
    
    match /bantaTopics/{topicID}/messages/{messageID}/messages/{submessageID} {
      allow read;
    }

    match /bantaTopics/{topicID}/messages/{messageID}/counters/{counterID} {
      allow read;
    }
  }
}