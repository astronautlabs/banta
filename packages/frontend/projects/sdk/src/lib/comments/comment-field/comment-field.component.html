<form class="new-message" (submit)="sendMessage()">
    <div class="avatar-container">
        <a  href="javascript:;"
            class="avatar"
            (click)="showEditAvatar()"
            [style.background-image]="'url(' + userAvatarUrl + ')'"
            ></a>
    </div>
    <div class="text-container">
        <div class="field-container">
            <div class="field-row">
                <mat-form-field appearance="outline" floatLabel="always">
                    <mat-label>{{label}}</mat-label>
                    <textarea
                        #textarea
                        name="message"
                        [placeholder]="placeholder"
                        matInput
                        cdkTextareaAutosize
                        [maxlength]="maxLength"
                        (keydown)="onKeyDown($event)"
                        (blur)="onBlur()"
                        [disabled]="sending"
                        [(ngModel)]="text"></textarea>
                </mat-form-field>
                <div class="options-line">
                    <mat-spinner *ngIf="sending" class="icon loading" diameter="18" strokeWidth="2"></mat-spinner>
                    <div *ngIf="sendError" class="error-message" [class.expanded]="expandError" [matTooltip]="sendError.message" (click)="alertError()">
                        <mat-icon *ngIf="sendError">error</mat-icon>
                        {{sendError.message}}
                    </div>
                    <div class="spacer"></div>
                    <div class="custom">
                        <ng-content></ng-content>
                    </div>
                    <banta-attachment-button 
                        *ngIf="allowAttachments"
                        (addedAttachment)="addedAttachment($event)"
                        (attachmentError)="attachmentError($event)"
                        ></banta-attachment-button>
                    <emoji-selector-button (selected)="insertEmoji($event)"></emoji-selector-button>
                </div>
                
            </div>
            <div #autocompleteContainer class="autocomplete-container">
                <div #autocomplete class="autocomplete" [class.visible]="autocompleteVisible">

                    <div>
                        <strong>{{completionPrefix}}</strong>...
                    </div>
                    <a
                        mat-button
                        *ngFor="let option of autocompleteOptions; index as index"
                        (click)="activateAutoComplete(option)"
                        [class.active]="autoCompleteSelected === index"
                        >
                        {{option.label}}
                    </a>
                </div>
            </div>


            <div *ngIf="chatMessageAttachments && chatMessageAttachments.length" class="message-attachments-container">
                <div *ngFor="let attachment of chatMessageAttachments; index as attachmentIndex"
                    class="message-attachment" [class.with-border]="!attachment.url">
                    <button (click)="removeAttachment(attachmentIndex)" mat-mini-fab color="primary" class="remove-img">
                        <mat-icon>close</mat-icon>
                    </button>
                    <ng-container *ngIf="attachment.transientState?.error">
                        <mat-icon class="error">close</mat-icon>
                        <em class="error">{{attachment.transientState?.errorMessage || 'Error'}}</em>
                    </ng-container>
                    <ng-container *ngIf="!attachment.transientState?.error">
                        <ng-container *ngIf="attachment.transientState?.uploading">
                            <mat-spinner></mat-spinner>
                            <em>Uploading...</em>
                        </ng-container>
                        <ng-container *ngIf="!attachment.transientState?.uploading">
                            <img [src]="attachment.url" alt="Message Attachment">
                        </ng-container>
                    </ng-container>
                </div>
            </div>

        </div>
    </div>
    <div class="actions">
        <ng-container *ngIf="!user">
            <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="showSignIn()"
                >{{signInLabel}}</button>
        </ng-container>
        <ng-container *ngIf="user">
            <button
                mat-raised-button
                class="send"
                color="primary"
                [disabled]="!sendButtonEnabled"
                >
                <ng-container *ngIf="canComment">
                    <mat-icon *ngIf="!sending">chevron_right</mat-icon>
                    <mat-spinner *ngIf="sending" class="icon" diameter="18" strokeWidth="2"></mat-spinner>
                </ng-container>
                <span class="label">
                    <ng-container *ngIf="!canComment">
                        {{permissionDeniedLabel}}
                    </ng-container>
                    <ng-container *ngIf="canComment">
                        <ng-container *ngIf="!sending">
                            {{sendLabel}}
                        </ng-container>
                        <ng-container *ngIf="sending">
                            {{sendingLabel}}
                        </ng-container>
                    </ng-container>
                </span>
            </button>
        </ng-container>
    </div>
</form>