
<mat-menu #pointItemMenu="matMenu">
    <button mat-menu-item (click)="share()">
        <mat-icon>share</mat-icon>
        Share
    </button>
    <button *ngIf="!mine" mat-menu-item (click)="report()">
        <mat-icon>warning</mat-icon>
        Report
    </button>
    <button *ngIf="mine" [disabled]="!permissions?.canEdit" mat-menu-item (click)="startEdit()">
        <mat-icon>edit</mat-icon>
        Edit
    </button>
    <button *ngIf="mine" [disabled]="!permissions?.canDelete" mat-menu-item (click)="delete()">
        <mat-icon>delete</mat-icon>
        Delete
    </button>
</mat-menu>

<div class="message-content">
    <div class="user">
        <a
            href="javascript:;"
            class="avatar"
            (click)="selectAvatar(message.user)"
            [style.background-image]="avatarForUser(message.user)"></a>
        <a href="javascript:;" class="display-name" (click)="selectUser()">{{message.user.displayName}}</a>
        <a href="javascript:;" class="username" (click)="selectUsername(message.user)">@{{message.user.username}}</a>
        <span class="user-tag" *ngIf="message.user.tag">{{message.user.tag}}</span>
        <banta-timestamp [value]="message.sentAt"></banta-timestamp>
        <span class="spacer"></span>
    </div>
    <div class="content" *ngIf="!editing">
        <span class="banta-message-content" [innerHTML]="message.message | markdownToHtml"></span>

        <ng-container *ngIf="message.attachments?.length > 0">
            <banta-lightbox #lightbox></banta-lightbox>
            <div class="attachments-row" [class.single]="message.attachments?.length === 1" *ngIf="message.attachments && message.attachments?.length > 0">
                <a 
                    href="javascript:;" 
                    (click)="showLightbox(attachment)"
                    *ngFor="let attachment of message.attachments" 
                    >
                    <img [src]="attachment.url" alt="">
                </a>
            </div>
        </ng-container>

        <ul class="message-facts">
            <li *ngIf="message.edits?.length > 0">(Edited)</li>
        </ul>
    </div>
    <div class="content" *ngIf="editing" style="padding-bottom: 2em;">
        <div>
            <mat-form-field floatLabel="always" appearance="outline" style="width: 100%;">
                <mat-label>Edit Message</mat-label>
                <textarea matInput [(ngModel)]="editedMessage"></textarea>
            </mat-form-field>
        </div>
        <button mat-raised-button (click)="saveEdit()">Save</button> &nbsp;
        <button mat-button (click)="endEditing()">Cancel</button>
    </div>


    <div class="actions">
        <div class="spacer"></div>
        <div class="counted-action" *ngIf="showReplyAction">
            <button mat-button [matTooltip]="replyCount > 0 ? 'Replies' : 'Reply'" matTooltipPosition="below" (click)="select()">
                <mat-icon [inline]="true">comment</mat-icon>
                <span class="count-indicator">
                    {{replyCount > 0 ? 'Replies' : 'Reply'}}
                    {{replyCount > 0 ? '(' + replyCount + ')' : ''}}
                </span>
            </button>
        </div>
        <div class="counted-action" [class.active]="message.userState?.liked">
            <button 
                *ngIf="message.transientState?.liking"
                mat-icon-button 
                [disabled]="true" 
                [matTooltip]="upvoting ? 'Please wait...' : message.userState?.liked ? 'Unlike' : 'Like'" 
                matTooltipPosition="below" 
                >
                <mat-spinner [diameter]="15" style="margin-left: 1em;"></mat-spinner>
            </button>
            <button 
                *ngIf="!message.transientState?.liking"
                mat-button 
                [disabled]="!permissions?.canLike" 
                [matTooltip]="upvoting ? 'Please wait...' : 'Like'" 
                matTooltipPosition="below" 
                (click)="message.userState?.liked ? unlike() : like()" 
                >
                <mat-icon [inline]="true">thumb_up</mat-icon>
                <span class="count-indicator" *ngIf="message.likes > 0">
                    {{message.likes}}
                </span>
            </button>
        </div>

        <button mat-icon-button [matMenuTriggerFor]="pointItemMenu">
            <mat-icon [inline]="true">more_vert</mat-icon>
        </button>
    </div>
</div>
